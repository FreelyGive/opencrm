<?php
/**
 * @file
 * Enables modules and site configuration for an opencrm site installation.
 */

/**
 * Implements hook_install_tasks().
 */
function opencrm_install_tasks(&$install_state) {
  $tasks = array(
    'opencrm_install_profile_modules' => array(
      'display_name' => t('Install OpenCRM modules'),
      'type' => 'batch',
    ),
    'opencrm_final_site_setup' => array(
      'display_name' => t('Apply configuration'),
      'type' => 'batch',
      'display' => TRUE,
    ),
  );
  return $tasks;
}

/**
 * Installs required modules via a batch process.
 *
 * @param $install_state
 *   An array of information about the current installation state.
 *
 * @return array
 *   The batch definition.
 */
function opencrm_install_profile_modules(&$install_state) {
  $files = system_rebuild_module_data();

  $modules = array(
    'contacts' => 'contacts',
  );
  $opencrm_modules = $modules;
  // Always install required modules first. Respect the dependencies between
  // the modules.
  $required = array();
  $non_required = array();

  // Add modules that other modules depend on.
  foreach ($modules as $module) {
    if ($files[$module]->requires) {
      $module_requires = array_keys($files[$module]->requires);
      // Remove the opencrm modules from required modules.
      $module_requires = array_diff_key($module_requires, $opencrm_modules);
      $modules = array_merge($modules, $module_requires);
    }
  }
  $modules = array_unique($modules);
  // Remove the opencrm modules from to install modules.
  $modules = array_diff_key($modules, $opencrm_modules);
  foreach ($modules as $module) {
    if (!empty($files[$module]->info['required'])) {
      $required[$module] = $files[$module]->sort;
    }
    else {
      $non_required[$module] = $files[$module]->sort;
    }
  }
  arsort($required);

  $operations = array();
  foreach ($required + $non_required + $opencrm_modules as $module => $weight) {
    $operations[] = array('_opencrm_install_module_batch', array(array($module), $module));
  }

  $batch = array(
    'operations' => $operations,
    'title' => t('Install OpenCRM modules'),
    'error_message' => t('The installation has encountered an error.'),
  );
  return $batch;
}

/**
 * Implements callback_batch_operation().
 *
 * Performs batch installation of modules.
 */
function _opencrm_install_module_batch($module, $module_name, &$context) {
  set_time_limit(0);
  \Drupal::service('module_installer')->install($module, $dependencies = TRUE);
  $context['results'][] = $module;
  $context['message'] = t('Install %module_name module.', array('%module_name' => $module_name));
}

/**
 * Implements callback_batch_operation().
 *
 * Performs batch uninstallation of modules.
 */
function _opencrm_uninstall_module_batch($module, $module_name, &$context) {
  set_time_limit(0);
  \Drupal::service('module_installer')->uninstall($module, $dependencies = FALSE);
  $context['results'][] = $module;
  $context['message'] = t('Uninstalled %module_name module.', array('%module_name' => $module_name));
}

/**
 * Finalises site installation via a batch process.
 *
 * @param $install_state
 *   An array of information about the current installation state.
 *
 * @return array
 *   The batch definition.
 */
function opencrm_final_site_setup(&$install_state) {
  // Clear all status messages generated by modules installed in previous step.
  drupal_get_messages('status', TRUE);

  $batch = array();
  if (TRUE) {
    $batch['operations'][] = ['_opencrm_install_module_batch', array(array('opencrm_demo'), 'opencrm_demo')];

    // Generate demo content.
    $demo_content_types = [
      'file' => t('files'),
      'user' => t('users'),
//      'profile' => t('profiles'),
    ];
    foreach ($demo_content_types as $demo_type => $demo_description) {
      $batch['operations'][] = ['_opencrm_add_demo_batch', array($demo_type, $demo_description)];
    }

    // Uninstall opencrm_demo.
    $batch['operations'][] = ['_opencrm_uninstall_module_batch', array(array('opencrm_demo'), 'opencrm_demo')];
  }

  // Add some finalising steps.
  $final_batched = [
    'profile_weight' => t('Set weight of profile.'),
    'router_rebuild' => t('Rebuild router.'),
    'trigger_sapi_index' => t('Index search'),
    'cron_run' => t('Run cron.'),
    'import_optional_config' => t('Import optional configuration'),
  ];
  foreach ($final_batched as $process => $description) {
    $batch['operations'][] = ['_opencrm_finalise_batch', array($process, $description)];
  }

  return $batch;
}

/**
 * Implements callback_batch_operation().
 *
 * Performs batch demo content generation.
 */
function _opencrm_add_demo_batch($demo_type, $demo_description, &$context) {
  set_time_limit(0);

  $num_created = 0;

  $content_types = array($demo_type);
  $manager = \Drupal::service('plugin.manager.demo_content');
  $plugins = $manager->createInstances($content_types);

  /** @var \Drupal\opencrm_demo\DemoContentInterface $plugin */
  foreach ($plugins as $plugin) {
    $plugin->createContent();
    $num_created = $plugin->count();
  }

  $context['results'][] = $demo_type;
  $context['message'] = t('Generated %num %demo_description.', array('%num' => $num_created, '%demo_description' => $demo_description));
}

/**
 * Implements callback_batch_operation().
 *
 * Performs batch finalising.
 */
function _opencrm_finalise_batch($process, $description, &$context) {

  switch ($process) {
    case 'profile_weight':
      $profile = drupal_get_profile();

      // Installation profiles are always loaded last.
      module_set_weight($profile, 1000);
      break;

    case 'router_rebuild':
      // Build the router once after installing all modules.
      // This would normally happen upon KernelEvents::TERMINATE, but since the
      // installer does not use an HttpKernel, that event is never triggered.
      \Drupal::service('router.builder')->rebuild();
      break;

    case 'trigger_sapi_index':
      $indexes = \Drupal\search_api\Entity\Index::loadMultiple();
      /** @var \Drupal\search_api\Entity\Index $index */
      foreach ($indexes as $index) {
        $index->reindex();
      }
      break;

    case 'cron_run':
      // Run cron to populate update status tables (if available) so that users
      // will be warned if they've installed an out of date Drupal version.
      // Will also trigger indexing of profile-supplied content or feeds.
      \Drupal::service('cron')->run();
      break;

  }

  $context['results'][] = $process;
  $context['message'] = $description;
}
